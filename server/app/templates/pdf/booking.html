<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Бронирование № {{ booking.booking_number }}</title>
    <style>
      body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; }
      header, footer { text-align: center; }
      h1 { font-size: 22px; margin: 16px 0; }
      h2 { font-size: 20px; margin: 0 0 16px; }
      h3 { font-size: 18px; margin: 16px 0 8px; }
      h4 { font-size: 14px; margin: 16px 0 8px; }
      p { margin: 0 0 8px; }
      table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 12px; }
      th, td { border: 1px solid #000; padding: 4px; }
      th { background-color: #f0f0f0; }
      ul { list-style: none; padding: 0; margin: 0 0 16px 0; }
      footer p { font-size: 12px; }
    </style>
</head>
<body>
  <header>
    <h1>{{ brand_name|upper }}</h1>
    <h2>ВАУЧЕР‑ПОДТВЕРЖДЕНИЕ БРОНИРОВАНИЯ АВИАПЕРЕВОЗКИ</h2>
  </header>

  <h3>Бронирование № {{ booking.booking_number }} — {{ status_labels[booking.status] }}</h3>

  {% set buyer_name = (details.buyer_last_name or '') + ' ' + (details.buyer_first_name or '') %}
  {% if buyer_name.strip() or details.email_address or details.phone_number %}
    <h4>Покупатель</h4>
    <ul>
      {% if buyer_name.strip() %}<li>{{ buyer_name.strip() }}</li>{% endif %}
      {% if details.email_address %}<li>Email: {{ details.email_address }}</li>{% endif %}
      {% if details.phone_number %}<li>Телефон: {{ details.phone_number }}</li>{% endif %}
    </ul>
  {% endif %}

  {% if details.flights %}
    <h4>Рейсы</h4>
    <table>
      <tr>
        <th>№</th>
        <th>Откуда → Куда</th>
        <th>Вылет</th>
        <th>Прилёт</th>
        <th>Класс</th>
        <th>Тариф</th>
      </tr>
      {% for f in details.flights %}
        {% set route = f.route or {} %}
        {% set origin = route.origin_airport or {} %}
        {% set dest = route.destination_airport or {} %}
        {% set dir_key = 'outbound' if loop.index0 == 0 else 'return' %}
        {% set t = direction_tariffs.get(dir_key) %}
        <tr>
          <td>{{ f.airline_flight_number }}</td>
          <td>{{ origin.city_name }} ({{ origin.iata_code }}) → {{ dest.city_name }} ({{ dest.iata_code }})</td>
          <td>{{ format_date(f.scheduled_departure) }} {{ format_time(f.scheduled_departure_time) }}</td>
          <td>{{ format_date(f.scheduled_arrival) }} {{ format_time(f.scheduled_arrival_time) }}</td>
          <td>{% if t %}{{ seat_class_labels.get(t.seat_class, t.seat_class) }}{% endif %}</td>
          <td>{% if t %}{{ t.title }}{% endif %}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}

  {% if details.passengers %}
    <h4>Пассажиры</h4>
    <table>
      <tr>
        <th>ФИО</th>
        <th>Категория</th>
        <th>Пол</th>
        <th>Дата рождения</th>
        <th>Документ</th>
        <th>Гражданство</th>
      </tr>
      {% for p in details.passengers %}
        {% set full_name = (p.last_name or '') + ' ' + (p.first_name or '') + ' ' + (p.patronymic_name or '') %}
        {% set cat = passenger_labels.get(p.category, p.category) %}
        {% set gender = gender_labels.get(p.gender, p.gender) %}
        {% set doc_type = document_labels.get(p.document_type, p.document_type) %}
        {% set country = (p.citizenship or {}).name %}
        <tr>
          <td>{{ full_name.strip() }}</td>
          <td>{{ cat }}</td>
          <td>{{ gender }}</td>
          <td>{{ format_date(p.birth_date) }}</td>
          <td>{{ doc_type }} {{ p.document_number }}</td>
          <td>{{ country }}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}

  {% set price = details.price_details or {} %}
  {% if price %}
    {% set currency = (details.currency or booking.currency.value).upper() %}
    {% for direction in price.directions or [] %}
      {% set route = direction.route or {} %}
      {% set origin = route.origin_airport or {} %}
      {% set dest = route.destination_airport or {} %}
      {% set t = direction.tariff or {} %}
      {% set flight = (details.flights | selectattr('id', 'equalto', direction.flight_id) | list | first) %}
      {% set airline_name = (flight.airline or {}).name %}
      <h4>{{ origin.city_name }} → {{ dest.city_name }}</h4>
      {% if airline_name %}
        <p><strong>{{ airline_name }}</strong></p>
      {% endif %}
      {% if t %}
        <p><u>{{ seat_class_labels.get(t.seat_class, t.seat_class) }} — {{ t.title }}</u></p>
        <p>Ручная кладь: {% if t.hand_luggage %}{{ t.hand_luggage }}{% else %} — {% endif %} кг, Багаж: {% if t.baggage %}{{ t.baggage }}{% else %} — {% endif %} кг</p>
      {% endif %}
      <table>
        <tr>
          <th>Категория</th>
          <th>Кол-во</th>
          <th>Цена (ед.)</th>
          <th>Скидка (ед.)</th>
          <th>Итого</th>
        </tr>
        {% for p in direction.passengers or [] %}
          {% set cat = passengers_labels.get(p.category, p.category) %}
          <tr>
            <td>{{ cat }}</td>
            <td>{{ p.count }}</td>
            <td>{{ format_float(p.unit_fare_price or 0) }} {{ currency }}</td>
            <td>
              {% if p.unit_discount and (p.unit_discount > 0) %}
                - {{ format_float(p.unit_discount) }} {{ currency }}{% if p.discount_name %} ({{ p.discount_name }}){% endif %}
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ format_float(p.price or 0) }} {{ currency }}</td>
          </tr>
        {% endfor %}
      </table>
    {% endfor %}
    <h4>Итоговая стоимость</h4>
    <table>
      <tr>
        <td>Стоимость перевозки</td>
        <td>{{ format_float(price.fare_price or 0) }} {{ currency }}</td>
      </tr>
      {% for fee in price.fees or [] %}
        <tr>
          <td>{{ fee.name }}</td>
          <td>{{ format_float(fee.total or 0) }} {{ currency }}</td>
        </tr>
      {% endfor %}
      {% if (price.total_discounts or 0) > 0 %}
        <tr>
          <td>Скидка</td>
          <td>- {{ format_float(price.total_discounts) }} {{ currency }}</td>
        </tr>
      {% endif %}
      <tr>
        <td><strong>Итого</strong></td>
        <td><strong>{{ format_float(price.final_price or 0) }} {{ currency }}</strong></td>
      </tr>
    </table>
  {% endif %}

  <p style="margin-top: 16px; padding: 12px; background-color: #f9f9f9; border-left: 4px solid #333; font-weight: bold;">
    Маршрут-квитанции на забронированные места будут направлены на электронную почту, указанную при бронировании, в течение 24 часов с момента подтверждения этой брони
  </p>

  {% set payment = details.payment %}
  {% if payment %}
    {% set status = payment_status_labels.get(payment.payment_status, payment.payment_status) %}
    {% set method = payment_method_labels.get(payment.payment_method, payment.payment_method) %}
    {% set pay_currency = (payment.currency or currency).upper() %}
    <h4>Платёж</h4>
    <ul>
      <li>Статус: {{ status }}</li>
      <li>Метод: {{ method }}</li>
      <li>Сумма: {{ format_float(payment.amount or 0) }} {{ pay_currency }}</li>
      {% if payment.paid_at %}
        <li>Оплачен: {{ format_datetime(payment.paid_at) }}</li>
      {% endif %}
      {% if payment.provider_payment_id %}
        <li>ID платежа провайдера: {{ payment.provider_payment_id }}</li>
      {% endif %}
      </ul>
    {% endif %}

    <footer>
      <hr />
      <p>© {{ brand_full_name }} · <a href="{{ site_url }}">{{ site_url|replace('https://','')|replace('http://','') }}</a> · {{ support_email }}</p>
      <p>{{ legal_address }}</p>
      <p>ИНН {{ inn }} · ОГРН {{ ogrn }}</p>
    </footer>
  </body>
</html>
