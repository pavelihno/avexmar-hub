<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Бронирование № {{ booking.booking_number }}</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 12px; }
    header, footer { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
    th, td { border: 1px solid #000; padding: 4px; }
    ul { list-style: none; padding: 0; margin: 0 0 16px 0; }
  </style>
</head>
<body>
  <header>
    <h2>{{ brand_name }}</h2>
  </header>

  <h3>Бронирование № {{ booking.booking_number }} - {{ status_label }}</h3>

  {% set buyer_name = (details.buyer_last_name or '') + ' ' + (details.buyer_first_name or '') %}
  {% if buyer_name.strip() or details.email_address or details.phone_number %}
    <p><strong>Покупатель:</strong></p>
    <ul>
      {% if buyer_name.strip() %}<li>{{ buyer_name.strip() }}</li>{% endif %}
      {% if details.email_address %}<li>Email: {{ details.email_address }}</li>{% endif %}
      {% if details.phone_number %}<li>Телефон: {{ details.phone_number }}</li>{% endif %}
    </ul>
  {% endif %}

  {% if details.flights %}
    <p><strong>Рейсы:</strong></p>
    <table>
      <tr>
        <th>№</th>
        <th>Откуда → Куда</th>
        <th>Вылет</th>
        <th>Прилёт</th>
      </tr>
      {% for f in details.flights %}
        {% set route = f.route or {} %}
        {% set origin = route.origin_airport or {} %}
        {% set dest = route.destination_airport or {} %}
        <tr>
          <td>{{ f.airline_flight_number }}</td>
          <td>{{ origin.city_name }} ({{ origin.iata_code }}) → {{ dest.city_name }} ({{ dest.iata_code }})</td>
          <td>{{ f.scheduled_departure }} {{ f.scheduled_departure_time }}</td>
          <td>{{ f.scheduled_arrival }} {{ f.scheduled_arrival_time }}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}

  {% if details.passengers %}
    <p><strong>Пассажиры:</strong></p>
    <table>
      <tr>
        <th>ФИО</th>
        <th>Категория</th>
        <th>Пол</th>
        <th>Дата рождения</th>
        <th>Документ</th>
        <th>Гражданство</th>
      </tr>
      {% for p in details.passengers %}
        {% set full_name = (p.last_name or '') + ' ' + (p.first_name or '') + ' ' + (p.patronymic_name or '') %}
        {% set cat = category_labels.get(p.category, p.category) %}
        {% set gender = gender_labels.get(p.gender, p.gender) %}
        {% set doc_type = document_labels.get(p.document_type, p.document_type) %}
        {% set country = (p.citizenship or {}).country_name %}
        <tr>
          <td>{{ full_name.strip() }}</td>
          <td>{{ cat }}</td>
          <td>{{ gender }}</td>
          <td>{{ p.birth_date }}</td>
          <td>{{ doc_type }} {{ p.document_number }}</td>
          <td>{{ country }}</td>
        </tr>
      {% endfor %}
    </table>
  {% endif %}

  {% set price = details.price_details or {} %}
  {% if price %}
    {% set currency = (details.currency or booking.currency.value).upper() %}
    {% for direction in price.directions or [] %}
      {% set route = direction.route or {} %}
      {% set origin = route.origin_airport or {} %}
      {% set dest = route.destination_airport or {} %}
      <p><strong>Стоимость: {{ origin.city_name }} → {{ dest.city_name }}</strong></p>
      <table>
        <tr>
          <th>Категория</th>
          <th>Кол-во</th>
          <th>Итоговая цена</th>
        </tr>
        {% for p in direction.passengers or [] %}
          {% set cat = category_labels.get(p.category, p.category) %}
          <tr>
            <td>{{ cat }}</td>
            <td>{{ p.count }}</td>
            <td>{{ '%.2f'|format(p.final_price or 0) }} {{ currency }}</td>
          </tr>
        {% endfor %}
      </table>
    {% endfor %}
    <p><strong>Итоговая стоимость:</strong></p>
    <table>
      <tr><td>Тариф</td><td>{{ '%.2f'|format(price.fare_price or 0) }} {{ currency }}</td></tr>
      <tr><td>Сборы</td><td>{{ '%.2f'|format(price.total_fees or 0) }} {{ currency }}</td></tr>
      <tr><td>Скидки</td><td>{{ '%.2f'|format(price.total_discounts or 0) }} {{ currency }}</td></tr>
      <tr><td>Итого</td><td>{{ '%.2f'|format(price.final_price or 0) }} {{ currency }}</td></tr>
    </table>
  {% endif %}

  {% set payment = details.payment %}
  {% if payment %}
    {% set status = payment_status_labels.get(payment.payment_status, payment.payment_status) %}
    {% set method = payment_method_labels.get(payment.payment_method, payment.payment_method) %}
    {% set pay_currency = (payment.currency or currency).upper() %}
    <p><strong>Платёж:</strong></p>
    <ul>
      <li>Статус: {{ status }}</li>
      <li>Метод: {{ method }}</li>
      {% if payment.amount is not none %}
        <li>Сумма: {{ '%.2f'|format(payment.amount|float) }} {{ pay_currency }}</li>
      {% endif %}
      {% if payment.paid_at %}<li>Оплачен: {{ payment.paid_at }}</li>{% endif %}
    </ul>
  {% endif %}

  <footer>
    <hr />
    <p style="font-size:12px;">© Авексмар · <a href="{{ site_url }}">{{ site_url|replace('https://','')|replace('http://','') }}</a> · {{ support_email }}</p>
  </footer>
</body>
</html>

