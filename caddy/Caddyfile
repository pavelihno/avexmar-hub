{$CADDY_DOMAIN} {
    @mutating_methods {
        method POST
        method PUT
        method PATCH
        method DELETE
    }

    @error_responses expression `{http.response.status_code} >= 400`

    log caddy_success {
        no_hostname
        output file /var/log/app/caddy/out.log {
            roll_size 50MiB
            roll_keep 10
        }
        format json
    }

    log caddy_error {
        no_hostname
        output file /var/log/app/caddy/err.log {
            roll_size 50MiB
            roll_keep 10
        }
        format json
    }

    log_name @mutating_methods caddy_success

    handle_errors {
        log_name caddy_error
    }

    request_body @mutating_methods {
        max_size 10MB
    }

    log_append @mutating_methods client_ip {remote_ip}
    log_append @mutating_methods request_method {http.request.method}
    log_append @mutating_methods request_path {http.request.uri}
    log_append @mutating_methods request_query {http.request.uri.query}
    log_append @mutating_methods request_headers {http.request.headers}
    log_append @mutating_methods request_body {http.request.body}
    log_append @mutating_methods response_status {http.response.status}
    log_append @mutating_methods response_headers {http.response.headers}
    log_append @mutating_methods response_body {http.response.body}
    log_append @mutating_methods latency_ms {duration_ms}

    reverse_proxy client-app:80
}
